<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Using BedTool objects as iterators/generators &#8212; pybedtools 0.11.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=27fed22d" />
    <script src="_static/documentation_options.js?v=f3b36f1a"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Low-level operations" href="topical-low-level-ops.html" />
    <link rel="prev" title="Saving BedTool results" href="topical-saving.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="using-bedtool-objects-as-iterators-generators">
<span id="bedtools-as-iterators"></span><h1>Using BedTool objects as iterators/generators<a class="headerlink" href="#using-bedtool-objects-as-iterators-generators" title="Link to this heading">¶</a></h1>
<p>Typically, <code class="xref py py-mod docutils literal notranslate"><span class="pre">BedTool</span></code> objects are used somewhat like handles to individual
files on disk that contain BED lines.  To save disk space, <code class="xref py py-mod docutils literal notranslate"><span class="pre">BedTool</span></code>
objects also have the ability to “stream”, much like piping in Unix.  That
is, the data are created only one line at a time in memory, instead of
either creating a list of all data in memory or writing all data to disk.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You’ll need to be careful when using <code class="xref py py-mod docutils literal notranslate"><span class="pre">BedTool</span></code> objects as
generators, since any operation that reads all the features of a
<code class="xref py py-mod docutils literal notranslate"><span class="pre">BedTool</span></code> will consume the iterable.</p>
</div>
<p>To get a streaming BedTool, use the <code class="file docutils literal notranslate"><span class="pre">stream=True</span></code> kwarg.  This
<code class="xref py py-class docutils literal notranslate"><span class="pre">BedTool</span></code> will act a little differently from a standard, file-based
<code class="xref py py-class docutils literal notranslate"><span class="pre">BedTool</span></code>.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">pybedtools</span><span class="o">.</span><span class="n">example_bedtool</span><span class="p">(</span><span class="s1">&#39;a.bed&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">pybedtools</span><span class="o">.</span><span class="n">example_bedtool</span><span class="p">(</span><span class="s1">&#39;b.bed&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># checking the length consumes the iterator</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="go">3</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># nothing left, so checking length again returns 0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="go">0</span>
</pre></div>
</div>
<p>In some cases, a stream may be “rendered” to a temp file.  This is because
BEDTools programs can only accept one input file as <code class="file docutils literal notranslate"><span class="pre">stdin</span></code>.  This is typically
the first input (<code class="file docutils literal notranslate"><span class="pre">-i</span></code> or <code class="file docutils literal notranslate"><span class="pre">-a</span></code>), while the other input (<code class="file docutils literal notranslate"><span class="pre">-b</span></code>) must be a file.
Consider this example, where the second intersection needs to convert the
streaming BedTool to a file before sending to <code class="file docutils literal notranslate"><span class="pre">intersectBed</span></code>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">pybedtools</span><span class="o">.</span><span class="n">example_bedtool</span><span class="p">(</span><span class="s1">&#39;a.bed&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">pybedtools</span><span class="o">.</span><span class="n">example_bedtool</span><span class="p">(</span><span class="s1">&#39;b.bed&#39;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># first we set up a streaming BedTool:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># But supplying a streaming BedTool as the first unnamed argument</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># means it is being passed as -b to intersectBed, and so must be a file.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># In this case, `c` is rendered to a tempfile before being passed.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">d</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Chaining two streaming BedTool objects together?  You’ll need to be
careful, because sometimes this will result in deadlocks.  You’ll see zero
CPU usage as pybedtools tries to write to the stdin of a downstream BedTool
object.</p>
<p>For example, for two BedTool objects pointing to files that have &gt;5000
features, the following usually blocks:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
<p>The solution is to save to a tempfile first, or use non-streaming BedTools.
All of the following will work fine:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># only use file-based</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># using the second streaming BedTool is fine</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># if you have a streaming BedTool, &quot;render&quot; it to a tempfile with</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># saveas()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">saveas</span><span class="p">()</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
</pre></div>
</div>
<p>There’s a nice explanation of blocking along with figures at
<a class="reference external" href="http://www.pixelbeat.org/programming/stdio_buffering/">http://www.pixelbeat.org/programming/stdio_buffering/</a>.  Most solutions to
this blocking problem on stackoverflow suggest using threads, but in my
test cases this tends to make interactive IPython sessions act strangely.
Another option is to try pexpect, but I have been unable to get this to
work and it requires an additional dependency.</p>
<p>Contributions to help solve this would be most appreciated!</p>
<p>Example references:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="http://stackoverflow.com/questions/1595492/blocks-send-input-to-python-subprocess-pipeline">http://stackoverflow.com/questions/1595492/blocks-send-input-to-python-subprocess-pipeline</a></p></li>
<li><p><a class="reference external" href="http://stackoverflow.com/questions/375427/non-blocking-read-on-a-subprocess-pipe-in-python">http://stackoverflow.com/questions/375427/non-blocking-read-on-a-subprocess-pipe-in-python</a></p></li>
<li><p><a class="reference external" href="http://www.python.org/dev/peps/pep-3145/">http://www.python.org/dev/peps/pep-3145/</a></p></li>
<li><p><a class="reference external" href="http://stackoverflow.com/questions/3076542/how-can-i-read-all-availably-data-from-subprocess-popen-stdout-non-blocking/3078292#3078292">http://stackoverflow.com/questions/3076542/how-can-i-read-all-availably-data-from-subprocess-popen-stdout-non-blocking/3078292#3078292</a></p></li>
<li><p><a class="reference external" href="http://stackoverflow.com/questions/3140189/subprocess-popen-stdout-reading-stdout-in-real-time-again">http://stackoverflow.com/questions/3140189/subprocess-popen-stdout-reading-stdout-in-real-time-again</a> (and references therein)</p></li>
</ul>
</div></blockquote>
</div>
<section id="creating-a-bedtool-from-an-iterable">
<h2>Creating a <code class="xref py py-class docutils literal notranslate"><span class="pre">BedTool</span></code> from an iterable<a class="headerlink" href="#creating-a-bedtool-from-an-iterable" title="Link to this heading">¶</a></h2>
<p>You can create a <code class="xref py py-class docutils literal notranslate"><span class="pre">BedTool</span></code> on the fly from a generator or iterator – in
fact, this is what the <code class="xref py py-meth docutils literal notranslate"><span class="pre">BedTool.filter()</span></code> method does for you:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">pybedtools</span><span class="o">.</span><span class="n">example_bedtool</span><span class="p">(</span><span class="s1">&#39;a.bed&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="go">chr1        1       100     feature1        0       +</span>
<span class="go">chr1        100     200     feature2        0       +</span>
<span class="go">chr1        150     500     feature3        0       -</span>
<span class="go">chr1        900     950     feature4        0       +</span>


<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">pybedtools</span><span class="o">.</span><span class="n">BedTool</span><span class="p">(</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">a</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># this is the same as using filter:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
<p>We need to “render” these BedTools to string before we can check equality
– consuming them both – since they are both iterables for which <code class="file docutils literal notranslate"><span class="pre">==</span></code> is
not defined:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">==</span> <span class="n">c</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="w">    </span><span class="o">...</span>
<span class="gr">NotImplementedError</span>: <span class="n">Testing equality only supported for BedTools that point to a file</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
</section>
<section id="indexing-a-bedtool">
<h2>Indexing a <code class="xref py py-class docutils literal notranslate"><span class="pre">BedTool</span></code><a class="headerlink" href="#indexing-a-bedtool" title="Link to this heading">¶</a></h2>
<p>In some cases it may be useful to index into a <code class="xref py py-class docutils literal notranslate"><span class="pre">BedTool</span></code> object.  We can
use standard list slice syntax, and get an iterable of <code class="xref py py-class docutils literal notranslate"><span class="pre">Interval</span></code>
objects as a result.  This iterable can in turn be used to create a new <code class="xref py py-class docutils literal notranslate"><span class="pre">BedTool</span></code> instance:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">pybedtools</span><span class="o">.</span><span class="n">example_bedtool</span><span class="p">(</span><span class="s1">&#39;a.bed&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
<span class="go">&lt;itertools.islice object at 0x...&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="go">chr1        150     500     feature3        0       -</span>
<span class="go">chr1        900     950     feature4        0       +</span>


<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">pybedtools</span><span class="o">.</span><span class="n">example_bedtool</span><span class="p">(</span><span class="s1">&#39;b.bed&#39;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">pybedtools</span><span class="o">.</span><span class="n">BedTool</span><span class="p">(</span><span class="n">a</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
<span class="go">chr1        155     200     feature2        0       +</span>
<span class="go">chr1        155     200     feature3        0       -</span>
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">pybedtools</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="main.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="main.html#running-tests-compiling-docs">Running tests, compiling docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="3-brief-examples.html">Three brief examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial-contents.html">Tutorial Contents</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="topical-documentation-contents.html">Topical Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="topical-design-principles.html">Design principles</a></li>
<li class="toctree-l2"><a class="reference internal" href="topical-create-a-bedtool.html">Creating a <code class="xref py py-class docutils literal notranslate"><span class="pre">BedTool</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="topical-saving.html">Saving <code class="xref py py-class docutils literal notranslate"><span class="pre">BedTool</span></code> results</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Using BedTool objects as iterators/generators</a></li>
<li class="toctree-l2"><a class="reference internal" href="topical-low-level-ops.html">Low-level operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="topical-bam.html">Working with BAM files</a></li>
<li class="toctree-l2"><a class="reference internal" href="topical-bam-semantics.html">Notes on BAM file semantics</a></li>
<li class="toctree-l2"><a class="reference internal" href="topical-genome.html">Specifying genomes</a></li>
<li class="toctree-l2"><a class="reference internal" href="topical-random.html">Randomization</a></li>
<li class="toctree-l2"><a class="reference internal" href="topical-wrapping.html">Wrapping new tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="topical-comparisons.html">Comparisons</a></li>
<li class="toctree-l2"><a class="reference internal" href="sh-comparison.html">Shell script comparison</a></li>
<li class="toctree-l2"><a class="reference internal" href="pybedtools-dev-history.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pybedtools</span></code> development model</a></li>
<li class="toctree-l2"><a class="reference internal" href="flow-of-commands.html">Under the hood</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="FAQs.html">FAQs</a></li>
<li class="toctree-l1"><a class="reference internal" href="scripts.html">Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="autodoc_source.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pybedtools</span></code> Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="changes.html">Changelog</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  <li><a href="topical-documentation-contents.html">Topical Documentation</a><ul>
      <li>Previous: <a href="topical-saving.html" title="previous chapter">Saving <code class="xref py py-class docutils literal notranslate"><span class="pre">BedTool</span></code> results</a></li>
      <li>Next: <a href="topical-low-level-ops.html" title="next chapter">Low-level operations</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>

    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="topical-low-level-ops.html" title="Low-level operations"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="topical-saving.html" title="Saving BedTool results"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">pybedtools 0.11.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="topical-documentation-contents.html" accesskey="U">Topical Documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Using BedTool objects as iterators/generators</a></li> 
      </ul>
    </div>


    <div class="footer">
      &#169;2010-2015, Ryan Dale.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/topical-iterators.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>